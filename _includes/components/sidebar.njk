{# _includes/components/sidebar.njk #}
<nav class="sidebar">
  {% set currentUrl = page.url or '' %}
  {% set names = campaigns or site.campaigns or {} %}

  <ul class="sidebar-nav">
    <li>
      <a href="/" class="{% if currentUrl == '/' %}active{% endif %}">Home</a>
    </li>
    <li>
      <a href="/vault/campaigns/" class="{% if currentUrl | startsWith('/vault/campaigns/') %}active{% endif %}">
        Active Campaigns
      </a>
    </li>
    <li>
      <a href="/systems/" class="{% if currentUrl | startsWith('/systems/') %}active{% endif %}">
        Game Systems
      </a>
    </li>
    <li>
      <a href="/vault/past/" class="{% if currentUrl | startsWith('/vault/past/') %}active{% endif %}">
        Past Campaigns
      </a>
    </li>
    <li>
      <a href="/about/" class="{% if currentUrl | startsWith('/about/') %}active{% endif %}">
        About
      </a>
    </li>
  </ul>

  {# Extract campaign slug from /vault/campaigns/<slug>/... #}
  {% set parts = currentUrl.split('/') %}
  {% set campaignSlug = null %}
  {% if parts | length > 3 and parts[1] == 'vault' and parts[2] == 'campaigns' %}
    {% set campaignSlug = parts[3] %}
  {% endif %}

  {% if campaignSlug %}
    {# Build public, in-campaign nav tree #}
    {% set navTree = (collections.all | eleventyNavigation | navPublic | navForCampaign(campaignSlug)) %}

    {% if navTree | length %}
      <h3 class="sidebar-heading">
        {{ names[campaignSlug] or (campaignSlug | titleize) }}
      </h3>

      <ul class="campaign-nav">
        {# Only top-level nodes for this campaign #}
        {% for node in navTree if not node.parent %}
          <li>
            <a href="{{ node.url }}" class="{% if currentUrl == node.url %}active{% endif %}">
              {{ node.title }}
            </a>

            {# Expand only the branch weâ€™re inside #}
            {% if node.children and (node | currentBranch(currentUrl)) %}
              <ul>
                {% for child in node.children %}
                  <li>
                    <a href="{{ child.url }}" class="{% if currentUrl == child.url %}active{% endif %}">
                      {{ child.title }}
                    </a>

                    {% if child.children and (child | currentBranch(currentUrl)) %}
                      <ul>
                        {% for grand in child.children %}
                          <li>
                            <a href="{{ grand.url }}" class="{% if currentUrl == grand.url %}active{% endif %}">
                              {{ grand.title }}
                            </a>
                          </li>
                        {% endfor %}
                      </ul>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endif %}
</nav>
