{# _includes/components/sidebar.njk #}
<nav class="sidebar">
  {% set currentUrl = page.url or '' %}
  {% set names = campaigns or site.campaigns or {} %}

  <ul class="sidebar-nav">
    <li>
      <a href="/" class="{% if currentUrl == '/' %}active{% endif %}">Home</a>
    </li>
    <li>
      <a href="/vault/campaigns/" class="{% if currentUrl | startsWith('/vault/campaigns/') %}active{% endif %}">
        Active Campaigns
      </a>
    </li>
    <li>
      <a href="/systems/" class="{% if currentUrl | startsWith('/systems/') %}active{% endif %}">
        Game Systems
      </a>
    </li>
    <li>
      <a href="/vault/past/" class="{% if currentUrl | startsWith('/vault/past/') %}active{% endif %}">
        Past Campaigns
      </a>
    </li>
    <li>
      <a href="/about/" class="{% if currentUrl | startsWith('/about/') %}active{% endif %}">
        About
      </a>
    </li>
  </ul>

 {# --- CAMPAIGN NAV SECTION (robust) --- #}
{% set currentUrl = page.url or '' %}
{% set parts = currentUrl | pathSegments %}
{% set campaignSlug = null %}

{# public: /vault/campaigns/<slug>/... -> ["vault","campaigns","<slug>", ...] #}
{% if parts | length >= 3 and parts[0] == 'vault' and parts[1] == 'campaigns' %}
  {% set campaignSlug = parts[2] %}
{% elseif parts | length >= 4 and parts[0] == 'gm' and parts[1] == 'vault' and parts[2] == 'campaigns' %}
  {# gm: /gm/vault/campaigns/<slug>/... -> ["gm","vault","campaigns","<slug>", ...] #}
  {% set campaignSlug = parts[3] %}
{% endif %}

{% if campaignSlug %}
  {% set campaignRoot = '/vault/campaigns/' + (campaignSlug | slug) + '/' %}

  {# Build the nav tree *from campaign-only, public-for-nav items* #}
  {% set navTree = (collections.nav_content | byCampaign(campaignSlug) | eleventyNavigation) %}

  {% if navTree | length %}
    {# Find the exact campaign "home" node by URL == campaignRoot #}
    {% set campaignNode = null %}
    {% for n in navTree %}
      {% if n.url == campaignRoot %}
        {% set campaignNode = n %}
      {% endif %}
    {% endfor %}

    {# Fallback: a node under Home whose URL starts with the campaign root #}
    {% if not campaignNode %}
      {% for n in navTree %}
        {% if n.parent == 'Home' and (n.url | startsWith(campaignRoot)) %}
          {% set campaignNode = n %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if campaignNode %}
      <h3 class="sidebar-heading">
        {{ campaigns[campaignSlug] or campaignNode.title }}
      </h3>

      <ul class="campaign-nav">
        {# Show the campaign home link #}
        <li>
          <a href="{{ campaignNode.url }}" class="{% if currentUrl == campaignNode.url %}active{% endif %}">
            {{ campaignNode.title }}
          </a>
        </li>

        {# Show the first-level folders (Sessions, Items, etc.) #}
        {% for node in navTree %}
          {% if node.parent == campaignNode.key %}
            <li>
              <a href="{{ node.url }}" class="{% if currentUrl == node.url %}active{% endif %}">
                {{ node.title }}
              </a>

              {# Expand the active folder to reveal its pages #}
              {% if node.children and (node | currentBranch(currentUrl)) %}
                <ul>
                  {% for child in node.children %}
                    <li>
                      <a href="{{ child.url }}" class="{% if currentUrl == child.url %}active{% endif %}">
                        {{ child.title }}
                      </a>

                      {% if child.children and (child | currentBranch(currentUrl)) %}
                        <ul>
                          {% for grand in child.children %}
                            <li>
                              <a href="{{ grand.url }}" class="{% if currentUrl == grand.url %}active{% endif %}">
                                {{ grand.title }}
                              </a>
                            </li>
                          {% endfor %}
                        </ul>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    {% endif %}
  {% endif %}
{% endif %}