{# _includes/components/sidebar.njk #}
<nav class="sidebar">
  {% set currentUrl = page.url or '' %}
  {% set names = campaigns or site.campaigns or {} %}

  <ul class="sidebar-nav">
    <li>
      <a href="/" class="{% if currentUrl == '/' %}active{% endif %}">Home</a>
    </li>
    <li>
      <a href="/vault/campaigns/" class="{% if currentUrl | startsWith('/vault/campaigns/') %}active{% endif %}">
        Active Campaigns
      </a>
    </li>
    <li>
      <a href="/systems/" class="{% if currentUrl | startsWith('/systems/') %}active{% endif %}">
        Game Systems
      </a>
    </li>
    <li>
      <a href="/vault/past/" class="{% if currentUrl | startsWith('/vault/past/') %}active{% endif %}">
        Past Campaigns
      </a>
    </li>
    <li>
      <a href="/about/" class="{% if currentUrl | startsWith('/about/') %}active{% endif %}">
        About
      </a>
    </li>
  </ul>
{# --- CAMPAIGN NAV SECTION (scoped to one campaign node) --- #}
{% set currentUrl = page.url or '' %}
{% set parts = currentUrl | pathSegments %}
{% set campaignSlug = null %}

{# public: /vault/campaigns/<slug>/... -> ["vault","campaigns","<slug>", ...] #}
{% if parts | length >= 3 and parts[0] == 'vault' and parts[1] == 'campaigns' %}
  {% set campaignSlug = parts[2] %}
{% elseif parts | length >= 4 and parts[0] == 'gm' and parts[1] == 'vault' and parts[2] == 'campaigns' %}
  {# gm: /gm/vault/campaigns/<slug>/... -> ["gm","vault","campaigns","<slug>", ...] #}
  {% set campaignSlug = parts[3] %}
{% endif %}

{% if campaignSlug %}
  {% set campaignRoot = '/vault/campaigns/' + (campaignSlug | slug) + '/' %}

  {# Build the FULL nav tree once #}
  {% set navTree = collections.all | eleventyNavigation %}

  {# Find the campaign "home" node (URL exactly the campaign root) #}
  {% set campaignNode = null %}
  {% for n in navTree %}
    {% if n.url == campaignRoot %}
      {% set campaignNode = n %}
    {% endif %}
  {% endfor %}

  {# Fallback: a node under Home whose URL starts with the campaign root #}
  {% if not campaignNode %}
    {% for n in navTree %}
      {% if n.parent == 'Home' and (n.url | startsWith(campaignRoot)) %}
        {% set campaignNode = n %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if campaignNode %}
    <h3 class="sidebar-heading">
      {# Prefer your pretty name map if present #}
      {{ campaigns[campaignSlug] or campaignNode.title }}
    </h3>

    {# Helper macro: render one level of children for the active branch #}
    {% macro renderLevel(nodes) %}
      <ul class="campaign-nav">
        {% for node in nodes %}
          <li>
            <a href="{{ node.url }}" class="{% if currentUrl == node.url %}active{% endif %}">
              {{ node.title }}
            </a>

            {# Expand only if we are somewhere under this node #}
            {% if node.children and (node | currentBranch(currentUrl)) %}
              {{ renderLevel(node.children) }}
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endmacro %}

    {# Show the campaign home link itself #}
    <ul class="campaign-nav">
      <li>
        <a href="{{ campaignNode.url }}" class="{% if currentUrl == campaignNode.url %}active{% endif %}">
          {{ campaignNode.title }}
        </a>
      </li>
    </ul>

    {# Now render ONLY that nodeâ€™s children (e.g., Sessions, Items, etc.) #}
    {% if campaignNode.children %}
      {{ renderLevel(campaignNode.children) }}
    {% endif %}
  {% endif %}
{% endif %}
