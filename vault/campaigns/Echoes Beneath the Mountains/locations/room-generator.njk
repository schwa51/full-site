---
title: Room Generator (Moria)
layout: layout.njk
permalink: /echoes-beneath-the-mountains/rooms/room-generator/
publish: true
theme: tor
campaign: echoes
eleventyNavigation:
  key: Room Generator
  parent: Locations
  order: 1
# Set this to your published-to-web CSV link (must end with output=csv)
sheetCsv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSigeq-FkJYBvFAPcVBiBM9-J9q3iAlEaiJP8U-7SJo1V2nCNAmOQA-eQ1IHO1tuY31EG757Le57GzI/pub?output=csv"
---

<h1 class="sr-only">Moria Room Generator</h1>

<section class="tor-card">
  <div class="tor-card__body">
    <h2 class="tor-title">Generate a Random Room</h2>
    <p class="muted">Rolls four d12 results (11 = Eye Rune, 12 = G Rune) from a fixed Google Sheet.</p>

    <div class="flex" style="gap:.5rem; align-items:center; flex-wrap:wrap;">
      <button id="rollAll" class="tor-btn" type="button">Roll All</button>
      <button id="rerollRoom" class="tor-btn tor-btn--ghost" type="button" title="Reroll everything">Reroll</button>
      <div class="muted" style="font-size:.9em;">
        Using sheet:&nbsp;<code id="activeSheet"></code>
      </div>
    </div>

    <details style="margin-top:.5rem;">
      <summary>Preset Rolls (optional)</summary>
      <div class="grid" style="grid-template-columns: repeat(4,1fr); gap:.5rem; margin-top:.5rem;">
        <input id="r1" class="tor-input" type="text" inputmode="numeric" placeholder="1–12/eye/g" aria-label="Roll 1">
        <input id="r2" class="tor-input" type="text" inputmode="numeric" placeholder="1–12/eye/g" aria-label="Roll 2">
        <input id="r3" class="tor-input" type="text" inputmode="numeric" placeholder="1–12/eye/g" aria-label="Roll 3">
        <input id="r4" class="tor-input" type="text" inputmode="numeric" placeholder="1–12/eye/g" aria-label="Roll 4">
      </div>
      <p class="muted" style="margin-top:.25rem;">Leave blank to roll randomly. Use <code>eye</code> for 11 and <code>g</code> for 12.</p>
    </details>

    <hr class="tor-hr">

    <div id="results" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap: 1rem;">
      <div class="card" data-slot="1">
        <div class="card__hdr">Chamber Type <span class="muted" id="roll1"></span></div>
        <div class="card__body" id="text1">—</div>
        <div class="card__ftr"><button class="tor-btn tor-btn--sm" data-reroll="1">Reroll Type</button></div>
      </div>
      <div class="card" data-slot="2">
        <div class="card__hdr">Condition <span class="muted" id="roll2"></span></div>
        <div class="card__body" id="text2">—</div>
        <div class="card__ftr"><button class="tor-btn tor-btn--sm" data-reroll="2">Reroll Condition</button></div>
      </div>
      <div class="card" data-slot="3">
        <div class="card__hdr">Appearance <span class="muted" id="roll3"></span></div>
        <div class="card__body" id="text3">—</div>
        <div class="card__ftr"><button class="tor-btn tor-btn--sm" data-reroll="3">Reroll Appearance</button></div>
      </div>
      <div class="card" data-slot="4">
        <div class="card__hdr">Challenge <span class="muted" id="roll4"></span></div>
        <div class="card__body" id="text4">—</div>
        <div class="card__ftr"><button class="tor-btn tor-btn--sm" data-reroll="4">Reroll Challenge</button></div>
      </div>
    </div>

    <details style="margin-top:1rem;">
      <summary>Debug</summary>
      <pre id="debug" class="tor-pre"></pre>
    </details>
  </div>
</section>

<style>
  .card{background:#fffefb;border:1px solid var(--color-border, #e5dfd6);border-radius:14px;padding:1rem}
  .card__hdr{font-weight:600;margin-bottom:.25rem}
  .card__body{min-height:3.5rem}
  .card__body .desc{color:var(--color-muted,#6f6a63);font-size:.95em;margin-top:.375rem}
  .card__ftr{margin-top:.5rem}
</style>

<script>
(function(){
  // Front matter sheetCsv injected by Nunjucks
  const DEFAULT_SHEET = {{ sheetCsv | dump | safe }};

  const rollAllBtn = document.getElementById("rollAll");
  const rerollAllBtn = document.getElementById("rerollRoom");
  const debug = document.getElementById("debug");
  const activeSheetEl = document.getElementById("activeSheet");

  // Robust rune/number normalizer
  const toRune = (n) => {
    let s = String(n ?? "")
      .normalize("NFKD")
      .replace(/^\uFEFF/, "")
      .replace(/[\u200B-\u200D\u2060]/g, "")
      .replace(/\u00A0/g, " ")
      .toLowerCase()
      .trim();

    if (!s) return "";
    if (s === "11" || s === "eye") return "eye";
    if (s === "12" || s === "g")   return "g";
    if (/\beye\b/.test(s)) return "eye";
    if (/\bg\b/.test(s))   return "g";

    const num = parseInt(s, 10);
    if (!Number.isNaN(num)) return (num === 11) ? "eye" : (num === 12 ? "g" : num);
    return s;
  };

  const rollD12 = () => {
    const n = Math.floor(Math.random() * 12) + 1;
    return toRune(n);
  };

  const csvToRows = (csv) => {
    const lines = csv.replace(/\r\n/g, "\n").split(/\n+/).filter(Boolean);
    return lines.map(line => {
      const out = [];
      let cur = "", inQ = false;
      for (let i=0;i<line.length;i++){
        const c = line[i];
        if (c === '\"') { inQ = !inQ; continue; }
        if (c === ',' && !inQ) { out.push(cur); cur = ""; continue; }
        cur += c;
      }
      out.push(cur);
      // Clean cells, keep first 4 columns
      return out.map(s => String(s ?? "")
        .normalize("NFKD")
        .replace(/^\uFEFF/, "")
        .replace(/[\u200B-\u200D\u2060]/g, "")
        .replace(/\u00A0/g, " ")
        .trim()
      ).slice(0,4);
    });
  };

  function groupSheet(rows){
    // rows: [slot, key, title, desc]
    if (rows.length && isNaN(parseInt(rows[0][0],10))) rows = rows.slice(1);
    const groups = {1:{},2:{},3:{},4:{}};
    rows.forEach(r => {
      const [slotRaw, keyRaw, title, desc] = r.slice(0,4);
      const slot = Number(slotRaw);
      if (![1,2,3,4].includes(slot)) return;
      const key = toRune(keyRaw);
      groups[slot][String(key)] = { title: title || "", desc: desc || "" };
    });
    return groups;
  }

  function displayRoll(slot, val, entry){
    const label = (val === "eye") ? "· roll 11 (Eye Rune)" : (val === "g" ? "· roll 12 (G Rune)" : "· roll " + String(val));
    document.getElementById("roll"+slot).textContent = label;
    const target = document.getElementById("text"+slot);
    const title = entry?.title || "—";
    const desc  = entry?.desc  || "";
    target.innerHTML = desc ? `<div>${title}</div><div class="desc">${desc}</div>` : `<div>${title}</div>`;
  }

  function pick(groups, slot, forced){
    const val = forced ?? rollD12();
    const key = String(val);
    const entry = groups?.[slot]?.[key] || { title: "", desc: "" };
    displayRoll(slot, val, entry);
    return val;
  }

  function renderAll(groups, preset){
    const v1 = pick(groups, 1, preset?.[0]);
    const v2 = pick(groups, 2, preset?.[1]);
    const v3 = pick(groups, 3, preset?.[2]);
    const v4 = pick(groups, 4, preset?.[3]);
    return [v1,v2,v3,v4];
  }

  async function fetchCsv(url){
    const res = await fetch(url, { credentials: "omit", cache: "no-cache" });
    if (!res.ok) throw new Error("Failed to fetch sheet: " + res.status);
    const txt = await res.text();
    return txt;
  }

  function getPresetFromInputs(){
    const ids = ["r1","r2","r3","r4"];
    const vals = ids.map(id => {
      const el = document.getElementById(id);
      const v = el ? el.value.trim() : "";
      if (!v) return undefined;
      return toRune(v);
    });
    return vals;
  }

  async function loadAndRender(sheetUrl, preset){
    activeSheetEl.textContent = sheetUrl;
    const csv = await fetchCsv(sheetUrl);
    const rows = csvToRows(csv);
    const groups = groupSheet(rows);
    renderAll(groups, preset);

    // Attach per-card rerolls
    document.querySelectorAll("[data-reroll]").forEach(btn => {
      btn.onclick = () => {
        const slot = Number(btn.getAttribute("data-reroll"));
        pick(groups, slot, undefined);
      };
    });

    // Buttons
    rerollAllBtn.onclick = () => renderAll(groups, undefined);
    rollAllBtn.onclick = () => renderAll(groups, getPresetFromInputs());

    // Debug
    debug.textContent = JSON.stringify(groups, null, 2);
  }

  // Allow optional override via ?sheet= for testing; default to front matter
  const params = new URLSearchParams(location.search);
  const SHEET = params.get("sheet") || DEFAULT_SHEET;

  // Initial load
  loadAndRender(SHEET, getPresetFromInputs());
})();
</script>
